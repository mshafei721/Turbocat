# T1.6: OAuth Callback Page Implementation Plan

## Goal
Create a frontend OAuth callback page that receives JWT tokens from the backend OAuth flow, stores them securely using httpOnly cookies, and redirects users to the dashboard.

## Scope
- Create OAuth callback page at `/auth/oauth/success` and `/auth/oauth/error`
- Parse JWT tokens from URL query parameters
- Create API route to set httpOnly cookies
- Store tokens securely in httpOnly cookies
- Redirect to dashboard on success
- Handle errors gracefully with retry option

## Non-Goals
- Token refresh logic (future task)
- OAuth provider selection UI (already done in T1.5)
- Settings OAuth management (T1.7)
- Comprehensive tests (T1.8)

## Constraints
- Must follow existing session/cookie patterns from Google OAuth callback
- Must use existing session utilities
- Must work with backend JWT tokens from T1.1-T1.4
- Cannot modify backend code
- Must be accessible to users without technical knowledge

## Assumptions
- Backend redirects to `/auth/oauth/success?accessToken=...&refreshToken=...`
- Backend redirects to `/auth/oauth/error?error=...` on failure
- Frontend environment variable `NEXT_PUBLIC_API_URL` is set
- Next.js App Router (not Pages Router)
- Existing session infrastructure uses httpOnly cookies

## Risks
1. **Tokens exposed in URL**: Mitigated by immediate extraction and URL cleanup
2. **XSS attacks**: Mitigated by httpOnly cookies
3. **Session not created**: Mitigated by error handling and redirect to login
4. **Browser doesn't support cookies**: User will see error, can try again

## Rollback Strategy
If OAuth callback fails:
1. Delete newly created files
2. Backend OAuth flow (T1.1-T1.4) still works but frontend can't complete flow
3. Existing Vercel/Google OAuth flows still work (separate implementation)
4. Users can still use email/password login

## Implementation Steps

### 1. Create API Route for Setting Cookies
**File:** `turbocat-agent/app/api/auth/oauth/set-session/route.ts`

Purpose: Set httpOnly cookies for JWT tokens (secure, no XSS risk)

Pattern: Follow existing `create.ts` and `saveSession` patterns

### 2. Create OAuth Success Callback Page
**File:** `turbocat-agent/app/(auth)/oauth/success/page.tsx`

Flow:
1. Extract tokens from URL params
2. Validate tokens exist
3. Call API route to set cookies
4. Show loading state
5. Redirect to dashboard

### 3. Create OAuth Error Callback Page
**File:** `turbocat-agent/app/(auth)/oauth/error/page.tsx`

Flow:
1. Extract error from URL params
2. Display user-friendly error message
3. Provide "Try Again" button to redirect to login

### 4. Update Backend Redirect URLs
**Note:** Backend already configured in T1.3, just verify:
- Success: `${FRONTEND_URL}/auth/oauth/success?accessToken=...&refreshToken=...`
- Error: `${FRONTEND_URL}/auth/oauth/error?error=oauth_failed`

### 5. Testing Strategy
- Manual test: Click OAuth button → Complete flow → Verify dashboard access
- Check cookies are httpOnly in DevTools
- Test error path by triggering OAuth failure
- Verify URL is cleaned after token extraction

## Acceptance Criteria
- [X] Callback page extracts tokens from URL
- [X] Tokens stored in httpOnly cookies
- [X] User redirected to dashboard on success
- [X] Errors handled gracefully with retry option
- [X] TypeScript types defined
- [X] Follows existing auth patterns

## Files to Create/Modify
1. `turbocat-agent/app/api/auth/oauth/set-session/route.ts` (API route)
2. `turbocat-agent/app/(auth)/oauth/success/page.tsx` (success page)
3. `turbocat-agent/app/(auth)/oauth/error/page.tsx` (error page)
4. `.sisyphus/notepads/epic1-oauth/learnings.md` (document learnings)

## Effort Estimate
2 hours (as per TASKS.md)
