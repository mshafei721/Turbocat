# T1.8 - OAuth Integration Manual Test Plan

**Task:** OAuth Integration Tests
**Date:** 2026-01-12
**Tester:** AI Agent (Claude Sonnet 4.5)
**Environment:** Local Development

---

## Test Environment Setup

### Prerequisites
- [ ] Backend running on http://localhost:3001
- [ ] Frontend running on http://localhost:3000
- [ ] PostgreSQL database running
- [ ] Redis running (for CSRF state storage)
- [ ] OAuth provider credentials configured (.env):
  - [ ] GOOGLE_CLIENT_ID and GOOGLE_CLIENT_SECRET
  - [ ] GITHUB_CLIENT_ID and GITHUB_CLIENT_SECRET
  - [ ] MICROSOFT_CLIENT_ID and MICROSOFT_CLIENT_SECRET
- [ ] ENABLE_OAUTH_LOGIN=true
- [ ] ENCRYPTION_KEY set (32+ characters)

### Test Accounts
- Google: Use test Google account
- GitHub: Use test GitHub account
- Microsoft: Use test Microsoft account
- Email/Password: test@example.com / TestPass123!

---

## 1. OAuth Initiation Tests

### 1.1 Google OAuth Initiation
**Steps:**
1. Navigate to http://localhost:3000/login
2. Click "Sign in with Google" button
3. Observe redirect to Google OAuth page

**Expected Results:**
- [ ] Redirects to accounts.google.com
- [ ] URL contains client_id parameter
- [ ] URL contains redirect_uri parameter
- [ ] URL contains state parameter (UUID format)
- [ ] URL contains scope=openid profile email
- [ ] URL contains access_type=offline
- [ ] State stored in Redis with 10-minute TTL

**Actual Results:**
_To be filled by manual tester_

---

### 1.2 GitHub OAuth Initiation
**Steps:**
1. Navigate to http://localhost:3000/login
2. Click "Sign in with GitHub" button
3. Observe redirect to GitHub OAuth page

**Expected Results:**
- [ ] Redirects to github.com/login/oauth/authorize
- [ ] URL contains correct client_id
- [ ] URL contains state parameter
- [ ] URL contains scope=read:user user:email

**Actual Results:**
_To be filled by manual tester_

---

### 1.3 Microsoft OAuth Initiation
**Steps:**
1. Navigate to http://localhost:3000/login
2. Click "Sign in with Microsoft" button
3. Observe redirect to Microsoft OAuth page

**Expected Results:**
- [ ] Redirects to login.microsoftonline.com
- [ ] URL contains correct client_id
- [ ] URL contains state parameter
- [ ] URL contains scope=openid profile email

**Actual Results:**
_To be filled by manual tester_

---

## 2. OAuth Callback Tests

### 2.1 Google OAuth - New User
**Steps:**
1. Click "Sign in with Google"
2. Complete Google authorization (use NEW email)
3. Grant all permissions
4. Observe redirect back to app

**Expected Results:**
- [ ] Redirects to http://localhost:3000/auth/oauth/success
- [ ] URL contains accessToken parameter
- [ ] URL contains refreshToken parameter
- [ ] New user created in database
- [ ] User has oauthProvider='google'
- [ ] User has oauthId set
- [ ] OAuth tokens encrypted in database
- [ ] emailVerified=true (OAuth providers verify emails)
- [ ] lastLoginAt timestamp set
- [ ] Redirects to dashboard after token storage

**Actual Results:**
_To be filled by manual tester_

---

### 2.2 Google OAuth - Existing User
**Steps:**
1. Sign in with Google (use EXISTING OAuth email)
2. Complete authorization

**Expected Results:**
- [ ] Existing user found
- [ ] User record updated (lastLoginAt, oauthAccessToken, oauthRefreshToken)
- [ ] No duplicate user created
- [ ] Redirects to dashboard
- [ ] User logged in successfully

**Actual Results:**
_To be filled by manual tester_

---

### 2.3 OAuth Error - User Denies Permission
**Steps:**
1. Click "Sign in with Google"
2. Click "Cancel" or "Deny" on Google authorization page

**Expected Results:**
- [ ] Redirects to http://localhost:3000/auth/oauth/error
- [ ] Error message displayed
- [ ] No user created
- [ ] "Try Again" button available

**Actual Results:**
_To be filled by manual tester_

---

## 3. Security Validation Tests

### 3.1 CSRF Protection - Valid State
**Steps:**
1. Initiate OAuth flow (click "Sign in with Google")
2. Complete authorization normally
3. Callback should succeed

**Expected Results:**
- [ ] State parameter generated on initiation
- [ ] State stored in Redis
- [ ] State validated on callback
- [ ] State deleted after use (one-time use)
- [ ] Callback succeeds

**Actual Results:**
_To be filled by manual tester_

---

### 3.2 CSRF Protection - Invalid State
**Steps:**
1. Initiate OAuth flow
2. Manually modify state parameter in callback URL
3. Access callback URL with modified state

**Expected Results:**
- [ ] State validation fails
- [ ] Redirects to error page
- [ ] Error message: "Invalid or expired state parameter"
- [ ] No user created or logged in

**Actual Results:**
_To be filled by manual tester_

---

### 3.3 CSRF Protection - Expired State
**Steps:**
1. Initiate OAuth flow
2. Wait 11 minutes (state TTL is 10 minutes)
3. Complete authorization

**Expected Results:**
- [ ] State not found in Redis (TTL expired)
- [ ] Callback fails
- [ ] Redirects to error page
- [ ] Error message mentions expiration

**Actual Results:**
_To be filled by manual tester_

---

### 3.4 CSRF Protection - Reused State (Replay Attack)
**Steps:**
1. Complete full OAuth flow (initiate + callback)
2. Save the callback URL with code and state
3. Try to access the same callback URL again

**Expected Results:**
- [ ] State already deleted (one-time use)
- [ ] Second callback fails
- [ ] Redirects to error page
- [ ] Replay attack prevented

**Actual Results:**
_To be filled by manual tester_

---

### 3.5 Rate Limiting - OAuth Initiation
**Steps:**
1. Click "Sign in with Google" 5 times rapidly (within 1 minute)
2. Click "Sign in with Google" a 6th time

**Expected Results:**
- [ ] First 5 requests succeed (return 302 redirect)
- [ ] 6th request returns 429 Too Many Requests
- [ ] Response body contains error message
- [ ] After 1 minute, requests work again

**Actual Results:**
_To be filled by manual tester_

---

### 3.6 Token Encryption - Database Storage
**Steps:**
1. Complete OAuth flow successfully
2. Query database for user's oauthAccessToken and oauthRefreshToken

**SQL Query:**
```sql
SELECT oauthAccessToken, oauthRefreshToken
FROM "User"
WHERE email = 'your-test-email@example.com';
```

**Expected Results:**
- [ ] oauthAccessToken is JSON string (not plaintext)
- [ ] oauthRefreshToken is JSON string (not plaintext)
- [ ] JSON contains fields: iv, content, tag
- [ ] Plaintext token NOT visible in database
- [ ] Format: {"iv":"base64","content":"base64","tag":"base64"}

**Actual Results:**
_To be filled by manual tester_

---

### 3.7 Feature Flag - OAuth Disabled
**Steps:**
1. Set ENABLE_OAUTH_LOGIN=false in backend .env
2. Restart backend
3. Try to initiate OAuth flow

**Expected Results:**
- [ ] GET /api/v1/auth/oauth/google returns 503
- [ ] Response body: SERVICE_UNAVAILABLE error
- [ ] Error message: "OAuth login is currently disabled"
- [ ] OAuth buttons should be hidden in frontend (if implemented)

**Actual Results:**
_To be filled by manual tester_

---

## 4. Error Handling Tests

### 4.1 Email Conflict - Existing Password User
**Steps:**
1. Create user with email test@example.com and password
2. Try to sign in with Google using same email (test@example.com)

**Expected Results:**
- [ ] OAuth flow fails
- [ ] Error message: "Account exists with email/password auth"
- [ ] Suggested action: "Log in with email and password"
- [ ] No OAuth user created

**Actual Results:**
_To be filled by manual tester_

---

### 4.2 Email Conflict - Different OAuth Provider
**Steps:**
1. Sign in with Google using test@example.com
2. Try to sign in with GitHub using same email (test@example.com)

**Expected Results:**
- [ ] OAuth flow fails
- [ ] Error message mentions existing provider (Google)
- [ ] Suggested action: "Use Google to log in"
- [ ] No duplicate user created

**Actual Results:**
_To be filled by manual tester_

---

### 4.3 Inactive User Login Attempt
**Steps:**
1. Create OAuth user
2. Set user.isActive = false in database
3. Try to log in with OAuth

**Expected Results:**
- [ ] Login fails
- [ ] Error message: "Account has been deactivated"
- [ ] User not logged in

**Actual Results:**
_To be filled by manual tester_

---

### 4.4 Soft-Deleted User Login Attempt
**Steps:**
1. Create OAuth user
2. Set user.deletedAt = (current timestamp) in database
3. Try to log in with OAuth

**Expected Results:**
- [ ] Login fails
- [ ] Error message: "Account has been deactivated"
- [ ] User not logged in

**Actual Results:**
_To be filled by manual tester_

---

## 5. OAuth Settings Management Tests

### 5.1 View Connected OAuth Providers
**Steps:**
1. Log in with email/password
2. Navigate to Settings > Account
3. Find "Connected Accounts" section

**Expected Results:**
- [ ] All 3 providers listed (Google, GitHub, Microsoft)
- [ ] Connection status displayed for each
- [ ] Unconnected providers show "Connect" button
- [ ] Connected providers show "Connected" status
- [ ] Connected providers show "Disconnect" button

**Actual Results:**
_To be filled by manual tester_

---

### 5.2 Connect OAuth Provider from Settings
**Steps:**
1. Log in with email/password
2. Go to Settings > Account
3. Click "Connect" button for Google
4. Complete OAuth flow
5. Return to settings page

**Expected Results:**
- [ ] OAuth flow initiated
- [ ] After authorization, returns to settings
- [ ] Google now shown as "Connected"
- [ ] Success message displayed
- [ ] User can now log in with email OR Google

**Actual Results:**
_To be filled by manual tester_

---

### 5.3 Disconnect OAuth Provider (Multiple Auth Methods)
**Steps:**
1. Ensure user has password AND OAuth connected
2. Go to Settings > Account
3. Click "Disconnect" for Google

**Expected Results:**
- [ ] **NOTE:** Backend disconnect endpoint NOT YET IMPLEMENTED (known issue)
- [ ] Frontend button exists but will fail
- [ ] This test cannot be completed until backend endpoint added

**Actual Results:**
_Backend endpoint missing - cannot test_

---

### 5.4 Prevent Disconnecting Last Auth Method
**Steps:**
1. Create user with ONLY OAuth (no password)
2. Go to Settings > Account
3. Try to disconnect OAuth provider

**Expected Results:**
- [ ] **NOTE:** Backend disconnect endpoint NOT YET IMPLEMENTED
- [ ] When implemented: Disconnect button should be disabled
- [ ] Warning message: "Cannot disconnect - this is your only login method"
- [ ] Suggested action: "Add password first"

**Actual Results:**
_Backend endpoint missing - cannot test_

---

## 6. Browser Compatibility Tests

### 6.1 Chrome
- [ ] OAuth initiation works
- [ ] OAuth callback works
- [ ] Tokens stored correctly
- [ ] Dashboard loads after login

### 6.2 Firefox
- [ ] OAuth initiation works
- [ ] OAuth callback works
- [ ] Tokens stored correctly
- [ ] Dashboard loads after login

### 6.3 Safari
- [ ] OAuth initiation works
- [ ] OAuth callback works
- [ ] Tokens stored correctly
- [ ] Dashboard loads after login

### 6.4 Edge
- [ ] OAuth initiation works
- [ ] OAuth callback works
- [ ] Tokens stored correctly
- [ ] Dashboard loads after login

---

## 7. Mobile Testing (Optional)

### 7.1 iOS Safari
- [ ] OAuth flow works on iPhone
- [ ] Touch targets appropriate size
- [ ] Redirects work correctly

### 7.2 Android Chrome
- [ ] OAuth flow works on Android
- [ ] Touch targets appropriate size
- [ ] Redirects work correctly

---

## Test Summary

**Total Tests:** 35+
**Tests Passed:** _To be filled_
**Tests Failed:** _To be filled_
**Tests Blocked:** 2 (disconnect tests - backend not implemented)
**Tests Skipped:** _To be filled_

**Overall Status:** ⚠️ PARTIALLY TESTABLE (disconnect endpoint missing)

---

## Known Issues Found During Testing

1. **Backend Disconnect Endpoint Missing:**
   - OAuth disconnect button exists in frontend
   - Backend DELETE /auth/oauth/:provider endpoint not implemented
   - Tests 5.3 and 5.4 cannot be completed

2. **User Model Limitation:**
   - User model supports only 1 OAuth provider (oauthProvider field)
   - Cannot connect multiple OAuth providers to same account
   - Documented in T1.7 completion report

3. _(Add any issues found during manual testing)_

---

## Recommendations

1. **Implement Backend Disconnect Endpoint:**
   - Add DELETE /api/v1/auth/oauth/:provider route
   - Validate user has alternative auth method before disconnect
   - Clear oauthProvider, oauthId, oauthAccessToken, oauthRefreshToken

2. **Extend User Model for Multiple OAuth Providers:**
   - Consider separate OAuthConnection table
   - Allow Google + GitHub + Microsoft all connected
   - Refactor schema to support multiple provider connections

3. **Add E2E Tests:**
   - Automate OAuth flows with Playwright/Cypress
   - Mock OAuth providers for reliable CI/CD testing
   - Test full happy paths automatically

4. **Enhance Error Messages:**
   - Make error messages more user-friendly
   - Add specific recovery actions for each error type
   - Consider inline help tooltips

---

## Appendix: Test Data

### Test User Accounts
| Email | Password | OAuth Provider | Purpose |
|-------|----------|---------------|---------|
| test-password@example.com | TestPass123! | None | Email/password only |
| test-google@gmail.com | N/A | Google | Google OAuth only |
| test-github@example.com | N/A | GitHub | GitHub OAuth only |
| test-microsoft@outlook.com | N/A | Microsoft | Microsoft OAuth only |
| test-both@example.com | TestPass123! | Google | Both password + OAuth |

### OAuth Provider URLs
- Google: https://accounts.google.com/o/oauth2/v2/auth
- GitHub: https://github.com/login/oauth/authorize
- Microsoft: https://login.microsoftonline.com/common/oauth2/v2.0/authorize

---

**End of Manual Test Plan**
